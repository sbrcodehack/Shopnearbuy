<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ShopNearBuy</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      margin: 0;
      padding: 0;
    }
    #map {
      height: 300px;
      margin: 10px;
      border-radius: 10px;
    }
    .controls {
      margin: 10px;
      display: flex;
      justify-content: center;
      gap: 10px;
    }
    input, select, textarea, button {
      display: block;
      margin: 8px auto;
      padding: 8px;
      width: 90%;
      max-width: 400px;
      border-radius: 8px;
    }
    #addBtn {
      font-size: 24px;
      cursor: pointer;
    }
    #addForm {
      display: none;
      background: #f9f9f9;
      padding: 10px;
      margin: 10px auto;
      border-radius: 10px;
      width: 90%;
      max-width: 400px;
    }
    #shopsList {
      margin-top: 20px;
    }
    .shop-card {
      background: #e0e0e0;
      margin: 10px auto;
      padding: 10px;
      border-radius: 10px;
      max-width: 400px;
    }
    .preview {
      width: 100%;
      max-height: 200px;
      border-radius: 10px;
      margin-top: 5px;
    }
  </style>
</head>
<body>
  <h1>ShopNearBuy</h1>
  <div id="map"></div>

  <div class="controls">
    <input type="text" id="search" placeholder="Search by name or category..." />
    <div id="addBtn">âž•</div>
  </div>

  <div id="addForm">
    <input type="text" id="shopName" placeholder="Shop Name" required />
    <input type="text" id="ownerName" placeholder="Owner Name" required />
    <select id="shopCategory">
      <option value="">Select Category</option>
      <option>Grocery</option>
      <option>Restaurant</option>
      <option>Salon</option>
      <option>Medical</option>
      <option>Electronics</option>
      <option>Other</option>
    </select>
    <textarea id="description" placeholder="Shop Description" required></textarea>

    <video id="camera" autoplay playsinline width="100%" style="max-height: 200px; border-radius: 10px;"></video>
    <button type="button" onclick="capturePhoto()">ðŸ“¸ Capture Photo</button>
    <canvas id="canvas" style="display: none;"></canvas>
    <img id="preview" class="preview" alt="Captured image" />

    <input type="text" id="contact" placeholder="Contact Number (optional)" />
    <button onclick="saveShop()">Save Shop</button>
  </div>

  <div id="shopsList"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    const SUPABASE_URL = 'https://jhedjiolhqdxmqjknipz.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpoZWRqaW9saHFkeG1xamtuaXB6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM1MzUzMjcsImV4cCI6MjA2OTExMTMyN30.z5aYCuIHuUb_GXqbGO8rMki-36f7SYT0PVAUeMvcS0Q';
    const headers = {
      'apikey': SUPABASE_KEY,
      'Authorization': 'Bearer ' + SUPABASE_KEY,
      'Content-Type': 'application/json'
    };

    let map = L.map('map').setView([20.5937, 78.9629], 5); // India center
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    let userLatLng = null;

    navigator.geolocation.getCurrentPosition(pos => {
      userLatLng = [pos.coords.latitude, pos.coords.longitude];
      map.setView(userLatLng, 16);
      L.marker(userLatLng).addTo(map).bindPopup("You are here").openPopup();
    }, () => {
      alert("Could not get location");
    });

    // Camera access
    const camera = document.getElementById('camera');
    const canvas = document.getElementById('canvas');
    const preview = document.getElementById('preview');
    let capturedImage = '';

    navigator.mediaDevices.getUserMedia({ video: true }).then(stream => {
      camera.srcObject = stream;
    });

    function capturePhoto() {
      const context = canvas.getContext('2d');
      canvas.width = camera.videoWidth;
      canvas.height = camera.videoHeight;
      context.drawImage(camera, 0, 0);
      capturedImage = canvas.toDataURL('image/jpeg');
      preview.src = capturedImage;
      preview.style.display = 'block';
    }

    // Add Shop Form Toggle
    document.getElementById('addBtn').onclick = () => {
      const form = document.getElementById('addForm');
      form.style.display = form.style.display === 'none' ? 'block' : 'none';
    };

    async function saveShop() {
      const shopName = document.getElementById('shopName').value;
      const ownerName = document.getElementById('ownerName').value;
      const description = document.getElementById('description').value;
      const category = document.getElementById('shopCategory').value;
      const contact = document.getElementById('contact').value;

      if (!shopName || !description || !category || !userLatLng) {
        alert("Please fill required fields and allow location.");
        return;
      }

      const { data, error } = await fetch(`${SUPABASE_URL}/rest/v1/shops`, {
        method: 'POST',
        headers,
        body: JSON.stringify({
          shop_name: shopName,
          owner_name: ownerName,
          description,
          category,
          contact,
          lat: userLatLng[0],
          lng: userLatLng[1],
          image_url: capturedImage
        })
      }).then(res => res.json()).catch(err => {
        console.log("Error saving shop:", err);
      });

      if (error) {
        alert("Failed to save shop.");
      } else {
        alert("Shop saved successfully!");
        loadShops();
        document.getElementById('addForm').reset();
        preview.style.display = 'none';
      }
    }

    async function loadShops() {
      try {
        const res = await fetch(`${SUPABASE_URL}/rest/v1/shops?select=*`, { headers });
        const shops = await res.json();
        const list = document.getElementById('shopsList');
        list.innerHTML = '';

        shops.forEach(shop => {
          if (shop.lat && shop.lng) {
            L.marker([shop.lat, shop.lng]).addTo(map).bindPopup(shop.shop_name);
          }

          list.innerHTML += `
            <div class="shop-card">
              <h3>${shop.shop_name}</h3>
              <p><strong>Owner:</strong> ${shop.owner_name}</p>
              <p><strong>Category:</strong> ${shop.category}</p>
              <p>${shop.description}</p>
              ${shop.contact ? `<p><strong>Contact:</strong> ${shop.contact}</p>` : ""}
              ${shop.image_url ? `<img class="preview" src="${shop.image_url}" alt="Shop Image"/>` : ""}
            </div>
          `;
        });
      } catch (e) {
        console.warn("Could not load shops. Check internet or Supabase.");
      }
    }

    window.onload = loadShops;

    // Search functionality
    document.getElementById('search').addEventListener('input', async function () {
      const query = this.value.toLowerCase();
      const res = await fetch(`${SUPABASE_URL}/rest/v1/shops?select=*`, { headers });
      const shops = await res.json();

      const filtered = shops.filter(shop =>
        shop.shop_name.toLowerCase().includes(query) ||
        shop.category.toLowerCase().includes(query)
      );

      const list = document.getElementById('shopsList');
      list.innerHTML = '';
      filtered.forEach(shop => {
        list.innerHTML += `
          <div class="shop-card">
            <h3>${shop.shop_name}</h3>
            <p><strong>Owner:</strong> ${shop.owner_name}</p>
            <p><strong>Category:</strong> ${shop.category}</p>
            <p>${shop.description}</p>
            ${shop.contact ? `<p><strong>Contact:</strong> ${shop.contact}</p>` : ""}
            ${shop.image_url ? `<img class="preview" src="${shop.image_url}" alt="Shop Image"/>` : ""}
          </div>
        `;
      });
    });
  </script>
</body>
</html>
